import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js"; // <-- ADICIONADO deleteObject

  const firebaseConfig = {
    apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
    authDomain: "inscricaosinuca.firebaseapp.com",
    projectId: "inscricaosinuca",
    storageBucket: "inscricaosinuca.appspot.com",
    messagingSenderId: "338241576305",
    appId: "1:338241576305:web:288b6124384c6be4f76ad0",
    measurementId: "G-PEDG30FS2R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const toggleButton = document.getElementById("toggleButton");
  const formSection = document.getElementById("formSection");
  const listSection = document.getElementById("listSection");
  const registrationForm = document.getElementById("registrationForm");
  const fotoInput = document.getElementById("fotoInput");
  const previewFoto = document.getElementById("previewFoto");
  const participantList = document.getElementById("participantList");
  const loadingMessage = document.getElementById("loadingMessage");
  // Adiciona uma refer√™ncia ao bot√£o de submit para poder desabilit√°-lo
  const submitButton = registrationForm.querySelector('button[type="submit"]');

  let showForm = false;
  let fotoFile = null;

  toggleButton.addEventListener("click", () => {
    showForm = !showForm;
    formSection.classList.toggle("hidden", !showForm);
    listSection.classList.toggle("hidden", showForm);
    toggleButton.textContent = showForm ? "Ver Participantes" : "Nova Inscri√ß√£o";
  });

  fotoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      fotoFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        previewFoto.src = reader.result;
        previewFoto.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }
  });

  registrationForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const matricula = document.getElementById("matricula").value.trim();
    const nome = document.getElementById("nome").value.trim();
    const setor = document.getElementById("setor").value.trim();

    if (!matricula || !nome || !setor || !fotoFile) {
      alert("Preencha todos os campos, incluindo a foto!");
      return;
    }

    // Desabilita o bot√£o para evitar envios m√∫ltiplos
    submitButton.disabled = true;
    submitButton.textContent = "Enviando...";

    try {
      const fileName = `${Date.now()}_${fotoFile.name}`;
      const storageRef = ref(storage, `fotos/${fileName}`);
      await uploadBytes(storageRef, fotoFile);
      const fotoURL = await getDownloadURL(storageRef);

      await addDoc(collection(db, "inscritos"), {
        matricula,
        nome,
        setor,
        fotoURL, // Salva a URL da foto
        fotoPath: storageRef.fullPath, // Salva o caminho do arquivo para facilitar a exclus√£o
        criado_em: new Date().toISOString()
      });

      // ---> MUDAN√áA PRINCIPAL AQUI <---
      alert("Inscri√ß√£o realizada com sucesso!");

      registrationForm.reset();
      previewFoto.classList.add("hidden");
      fotoFile = null;

      // Volta para a lista de participantes (sem recarregar a p√°gina)
      showForm = false;
      formSection.classList.add("hidden");
      listSection.classList.remove("hidden");
      toggleButton.textContent = "Nova Inscri√ß√£o";

    } catch (err) {
      console.error("Erro ao salvar inscri√ß√£o:", err);
      alert("Erro ao salvar. Verifique o console para mais detalhes.");
    } finally {
      // Reabilita o bot√£o, independentemente se deu certo ou errado
      submitButton.disabled = false;
      submitButton.textContent = "Enviar Inscri√ß√£o";
    }
  });

  const q = query(collection(db, "inscritos"), orderBy("criado_em", "desc"));
  onSnapshot(q, (snapshot) => {
    loadingMessage.classList.add("hidden");
    const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    participantList.innerHTML = "";
    if (entries.length === 0) {
      participantList.innerHTML = `<p class="text-sm text-gray-500">Nenhum participante ainda.</p>`;
    } else {
      entries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between p-2 border rounded-lg shadow-sm";

        div.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${entry.fotoURL}" class="w-12 h-12 rounded-full object-cover">
            <div>
              <p class="font-medium">${entry.nome}</p>
              <p class="text-sm text-gray-500">${entry.matricula} - ${entry.setor}</p>
            </div>
          </div>
          <button class="text-red-600 hover:text-red-800" data-id="${entry.id}" data-path="${entry.fotoPath}">üóëÔ∏è</button>
        `;

        const btn = div.querySelector("button");
        btn.addEventListener("click", async () => {
          const senha = prompt("Digite a senha para excluir:");
          if (senha === "dpsp123") {
            try {
              // Excluir documento do Firestore
              await deleteDoc(doc(db, "inscritos", entry.id));

              // Excluir foto do Storage
              if (entry.fotoPath) {
                const fotoRef = ref(storage, entry.fotoPath);
                await deleteObject(fotoRef);
              }
              
            } catch (error) {
              console.error("Erro ao excluir:", error);
              alert("N√£o foi poss√≠vel excluir o participante. Veja o console.");
            }
          } else if (senha !== null) { // Evita alerta se o usu√°rio cancelar o prompt
            alert("Senha incorreta.");
          }
        });

        participantList.appendChild(div);
      });
    }
  });
